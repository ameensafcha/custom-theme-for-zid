{% set marquee_text = settings.marquee_text_ar if session.lang == 'ar' else settings.marquee_text_en %}
{% if marquee_text and marquee_text | trim %}
<section section-id="{{ sectionId }}" class="marquee-section overflow-hidden py-3 md:py-5"
    style="background-color: {{ settings.bg_color | default('#000000') }}; color: {{ settings.text_color | default('#FFFFFF') }};">

    <div class="marquee-track-wrapper" data-speed="{{ settings.speed | default(50) }}"
        style="font-size: clamp(16px, 4vw, 22px);">
        <div class="marquee-track">
            <span class="marquee-text">{{ marquee_text }}</span>
        </div>
    </div>

    <style>
        [section-id="{{ sectionId }}"] .marquee-track-wrapper {
            overflow: hidden;
            width: 100%;
            display: flex;
            align-items: center;
        }

        [section-id="{{ sectionId }}"] .marquee-track {
            display: flex;
            width: max-content;
            animation: marquee-scroll-ltr linear infinite;
        }

        [section-id="{{ sectionId }}"] .marquee-text {
            padding-right: 80px;
            white-space: nowrap;
            /* In RTL, padding should be on the other side */
            padding-inline-end: 80px;
            padding-right: 0;
        }

        [section-id="{{ sectionId }}"]:hover .marquee-track {
            animation-play-state: paused;
        }

        @keyframes marquee-scroll-ltr {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        @keyframes marquee-scroll-rtl {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(50%);
            }
        }

        /* Direction-based animation */
        [dir="rtl"] [section-id="{{ sectionId }}"] .marquee-track {
            animation-name: marquee-scroll-rtl;
        }

        @media (prefers-reduced-motion: reduce) {
            [section-id="{{ sectionId }}"] .marquee-track {
                animation: none;
            }
        }
    </style>

    <script>
        (function () {
            const section = document.querySelector('[section-id="{{ sectionId }}"]');
            if (!section) return;

            const wrapper = section.querySelector(".marquee-track-wrapper");
            const track = section.querySelector(".marquee-track");
            const textContent = track.innerHTML;

            const speed = parseFloat(wrapper.getAttribute("data-speed")) || 50;
            const singleWidth = track.scrollWidth;
            const screenWidth = window.innerWidth;

            if (singleWidth > 0) {
                // Ensure the marquee is wide enough to cover the screen twice for seamless looping
                const copiesNeeded = Math.ceil((screenWidth * 2) / singleWidth) + 1;
                const fullContent = textContent.repeat(copiesNeeded);
                track.innerHTML = fullContent;

                // Duration based on half the new track length (since we scroll 50%)
                const totalWidth = track.scrollWidth;
                const distanceToTravel = totalWidth / 2;
                const duration = distanceToTravel / speed;

                track.style.animationDuration = duration + 's';
            }
        })();
    </script>
</section>
{% endif %}