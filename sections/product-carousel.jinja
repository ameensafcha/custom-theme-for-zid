{% if settings.products and settings.products.results %}
{% set products = settings.products.results %}
{% set carousel_uid = 'pc-' ~ range(1000,9999) | random %}

<section section-id="{{ sectionId }}" class="pt-8 md:pt-[5px] pb-0">
    <div>

        {# ===== Header: Title + View All ===== #}
        {% set title_text = settings.title_ar if session.lang == 'ar' else settings.title_en %}
        {% set more_text = settings.more_text_ar if session.lang == 'ar' else settings.more_text_en %}
        {% if title_text or settings.display_more %}
        <div class="flex items-center justify-between mb-8 px-4 md:px-16">
            {% if title_text %}
            <h2 class="text-xl md:text-[26px] font-semibold text-foreground">{{ title_text }}</h2>
            {% endif %}
            {% if settings.display_more and more_text %}
            <a href="{{ url_for('list_products') }}" class="text-primary text-xl md:text-[26px] font-medium underline">
                {{ more_text }}
            </a>
            {% endif %}
        </div>
        {% endif %}

        {# ===== Carousel Wrapper ===== #}
        <div class="pc-carousel" data-pc-carousel="{{ carousel_uid }}">
            <div class="pc-viewport overflow-hidden" data-pc-viewport>
                <div class="pc-container">
                    {% for product in products %}
                    <div class="pc-slide">

                        {# ===== Product Card ===== #}
                        <div class="pc-card">
                            {# Image Area #}
                            <a href="{{ url_for('product_details', slug=product.slug) }}" class="pc-img-wrap">
                                {# Main Image #}
                                <img {% if product.main_image and product.main_image.image %}
                                    src="{{ image_url(product.main_image.image.full_size, w=400, q=80, f='auto') }}" {%
                                    elif product.images and product.images|length> 0 %}
                                src="{{ image_url(product.images[0].image.full_size, w=400, q=80, f='auto') }}"
                                {% else %}
                                src="{{ image_url(('images/product-img.svg' | asset_url), w=400, q=100, f='auto') }}"
                                {% endif %}
                                alt="{{ product.name }}"
                                class="pc-img-front"
                                {% if loop.index > 4 %}loading="lazy"{% endif %}
                                />

                                {# Hover Image (2nd image) #}
                                {% if product.images and product.images|length > 1 %}
                                <img src="{{ image_url(product.images[1].image.full_size, w=400, q=80, f='auto') }}"
                                    alt="{{ product.name }}" class="pc-img-hover" loading="lazy" />
                                {% endif %}

                                {# Badges - top right #}
                                <div class="absolute top-3 flex flex-col gap-1.5 ltr:right-3 rtl:left-3 z-10">
                                    {# Discount Badge #}
                                    {% if product.discount_percentage and product.discount_percentage > 0 %}
                                    <span class="pc-badge-discount">-{{ product.discount_percentage }}%</span>
                                    {% endif %}
                                    {# Sale / Best Seller Badge #}
                                    {% if product.badge %}
                                    <span class="pc-badge-label">{{ product.badge.text }}</span>
                                    {% endif %}
                                    {% if product.keywords and product.keywords|length > 0 %}
                                    {% for keyword in product.keywords[:1] %}
                                    <span class="pc-badge-label">{{ keyword | upper }}</span>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </a>

                            {# Info Area #}
                            <div class="pc-info">
                                {# Price #}
                                {% if product.formatted_sale_price is not none %}
                                <p class="pc-price">
                                    {% if product.has_options %}{{ _("From") }} {% endif %}
                                    {{ product.formatted_sale_price }}
                                    <span class="pc-price-old">{{ product.formatted_price }}</span>
                                </p>
                                {% else %}
                                <p class="pc-price">
                                    {% if product.has_options %}{{ _("From") }} {% endif %}
                                    {{ product.formatted_price }}
                                </p>
                                {% endif %}

                                {# Product Name #}
                                <h3 class="pc-name">
                                    <a href="{{ url_for('product_details', slug=product.slug) }}">{{ product.name }}</a>
                                </h3>

                                {# Description #}
                                {% if product.short_description or product.description %}
                                <p class="pc-desc">
                                    {{ product.short_description|striptags|truncate(80) or
                                    product.description|striptags|truncate(80) }}
                                </p>
                                {% endif %}

                                {# Add To Cart Button #}
                                {% set is_out_of_stock = product.in_stock == false or (product.is_infinite == false and
                                product.quantity is not none and product.quantity <= 0) %} {% if is_out_of_stock %}
                                    <button class="pc-btn pc-btn-oos" data-notify-me-trigger="{{ product.id }}">
                                    {{ _("Notify me when available") }}
                                    </button>
                                    {% else %}
                                    {% set has_options = product.has_options or product.has_fields %}
                                    <button class="pc-btn" {% if has_options %} data-open-quick-view="true"
                                        data-product-id="{{ product.id }}" {% else %}
                                        data-add-to-cart="{{ product.id }}" {% endif %}>
                                        {{ _("Select options") if has_options else _("Add to cart") }}
                                    </button>
                                    {% endif %}
                            </div>
                        </div>

                    </div>
                    {% endfor %}
                </div>
            </div>

            {# Carousel Controls - centered with border wrapper #}
            <div class="flex items-center justify-center mt-8">
                <div class="pc-controls-wrap">
                    <button class="pc-arrow" data-pc-prev aria-label="Previous">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                            stroke="currentColor" class="w-5 h-5 rtl:rotate-180">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                        </svg>
                    </button>
                    <div class="pc-dots" data-pc-dots></div>
                    <button class="pc-arrow" data-pc-next aria-label="Next">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                            stroke="currentColor" class="w-5 h-5 rtl:rotate-180">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

    </div>
</section>

<style>
    /* ===== Carousel Layout ===== */
    [data-pc-carousel="{{ carousel_uid }}"] .pc-container {
        display: flex;
        gap: 1.25rem;
        transition: transform 0.4s ease;
    }

    [data-pc-carousel="{{ carousel_uid }}"] .pc-slide {
        flex: 0 0 calc(25% - 0.9375rem);
        min-width: 0;
    }

    @media (max-width: 1023px) {
        [data-pc-carousel="{{ carousel_uid }}"] .pc-slide {
            flex: 0 0 calc(33.333% - 0.833rem);
        }
    }

    @media (max-width: 767px) {
        [data-pc-carousel="{{ carousel_uid }}"] .pc-slide {
            flex: 0 0 calc(50% - 0.625rem);
        }
    }

    /* ===== Card ===== */
    .pc-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: #fff;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        transition: box-shadow 0.3s;
    }

    .pc-card:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    /* ===== Image Area ===== */
    .pc-img-wrap {
        position: relative;
        display: block;
        width: 100%;
        aspect-ratio: 1 / 1;
        overflow: hidden;
        border-radius: 16px 16px 0 0;
    }

    .pc-img-front,
    .pc-img-hover {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .pc-img-front {
        z-index: 2;
    }

    .pc-img-hover {
        z-index: 1;
        opacity: 0;
    }

    /* Hover: swap images + scale */
    .pc-card:hover .pc-img-front {
        opacity: 0;
        transform: scale(1.08);
    }

    .pc-card:hover .pc-img-hover {
        opacity: 1;
        transform: scale(1.08);
    }

    /* If no hover image, just scale */
    .pc-card:hover .pc-img-front:only-of-type {
        opacity: 1;
        transform: scale(1.08);
    }

    /* ===== Badges ===== */
    .pc-badge-discount {
        background: #1a1a1a;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 6px;
        text-align: center;
    }

    .pc-badge-label {
        background: #1a1a1a;
        color: #fff;
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: center;
    }

    /* ===== Info Area ===== */
    .pc-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 20px 20px 24px;
        flex: 1;
    }

    .pc-price {
        font-size: 14px;
        color: #333;
        font-weight: 400;
    }

    .pc-price-old {
        text-decoration: line-through;
        color: #999;
        margin-inline-start: 6px;
        font-size: 13px;
    }

    .pc-name {
        font-size: 18px;
        font-weight: 700;
        color: #111;
        line-height: 1.3;
    }

    .pc-name a {
        color: inherit;
        text-decoration: none;
    }

    .pc-desc {
        font-size: 13px;
        color: #666;
        line-height: 1.4;
        margin-bottom: 4px;
    }

    /* ===== Add to Cart Button ===== */
    .pc-btn {
        display: block;
        width: 100%;
        margin-top: 2rem;
        padding: 14px 20px;
        background-color: #0d6b4b;
        color: #fff;
        font-size: 15px;
        font-weight: 600;
        text-align: center;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .pc-btn:hover {
        background-color: #095a3e;
    }

    .pc-btn-oos {
        background-color: #666;
    }

    .pc-btn-oos:hover {
        background-color: #555;
    }

    /* ===== Controls Wrapper with Border ===== */
    .pc-controls-wrap {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        border: 1px solid #d1d5db;
        /* gray-300 */
        border-radius: 999px;
        padding: 6px 12px;
        background: #fff;
    }

    /* ===== Arrow Buttons ===== */
    .pc-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        background: transparent;
        color: #333;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pc-arrow:hover {
        color: #111;
        background: #f3f4f6;
    }

    .pc-arrow:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    /* ===== Dots ===== */
    .pc-dots {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .pc-dot {
        width: 28px;
        height: 4px;
        border-radius: 4px;
        background: #ccc;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        padding: 0;
    }

    .pc-dot.active {
        background: #111;
        width: 36px;
    }
</style>

<script>
    (function () {
        var root = document.querySelector('[data-pc-carousel="{{ carousel_uid }}"]');
        if (!root) return;

        var container = root.querySelector('.pc-container');
        var slides = root.querySelectorAll('.pc-slide');
        var prevBtn = root.querySelector('[data-pc-prev]');
        var nextBtn = root.querySelector('[data-pc-next]');
        var dotsWrap = root.querySelector('[data-pc-dots]');
        var currentPage = 0;
        var isRtl = document.documentElement.dir === 'rtl';

        function getPerPage() {
            if (window.innerWidth >= 1024) return 4;
            if (window.innerWidth >= 768) return 3;
            return 2;
        }

        function getTotalPages() {
            var perPage = getPerPage();
            return Math.max(1, Math.ceil(slides.length / perPage));
        }

        function buildDots() {
            dotsWrap.innerHTML = '';
            var total = getTotalPages();
            for (var i = 0; i < total; i++) {
                var dot = document.createElement('button');
                dot.className = 'pc-dot' + (i === currentPage ? ' active' : '');
                dot.setAttribute('aria-label', 'Page ' + (i + 1));
                dot.dataset.page = i;
                dot.addEventListener('click', function () {
                    currentPage = parseInt(this.dataset.page);
                    goTo(currentPage);
                });
                dotsWrap.appendChild(dot);
            }
        }

        function goTo(page) {
            var perPage = getPerPage();
            var totalPages = getTotalPages();
            currentPage = Math.max(0, Math.min(page, totalPages - 1));

            var slideEl = slides[0];
            var gap = 20; // 1.25rem
            var slideWidth = slideEl.offsetWidth + gap;
            var offset = currentPage * perPage * slideWidth;

            // Don't scroll past the end
            var maxOffset = container.scrollWidth - root.querySelector('.pc-viewport').offsetWidth;
            offset = Math.min(offset, maxOffset);

            var dir = isRtl ? 1 : -1;
            container.style.transform = 'translateX(' + (dir * offset) + 'px)';

            // Update dots
            var dots = dotsWrap.querySelectorAll('.pc-dot');
            dots.forEach(function (d, i) {
                d.classList.toggle('active', i === currentPage);
            });

            prevBtn.disabled = currentPage <= 0;
            nextBtn.disabled = currentPage >= totalPages - 1;
        }

        prevBtn.addEventListener('click', function () { goTo(currentPage - 1); });
        nextBtn.addEventListener('click', function () { goTo(currentPage + 1); });

        // Touch swipe
        var startX = 0;
        var viewport = root.querySelector('.pc-viewport');
        viewport.addEventListener('touchstart', function (e) { startX = e.touches[0].clientX; }, { passive: true });
        viewport.addEventListener('touchend', function (e) {
            var diff = e.changedTouches[0].clientX - startX;
            var threshold = 50;
            if (isRtl) diff = -diff;
            if (diff < -threshold) goTo(currentPage + 1);
            else if (diff > threshold) goTo(currentPage - 1);
        }, { passive: true });

        // Init
        buildDots();
        goTo(0);

        var resizeTimer;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
                if (currentPage >= getTotalPages()) currentPage = getTotalPages() - 1;
                buildDots();
                goTo(currentPage);
            }, 150);
        });
    })();
</script>

{% endif %}