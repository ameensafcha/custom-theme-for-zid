{% extends "layout.jinja" %}

{% block title %}{{ _("Reviews") }} – {{ product.name }} – {{ store.name }}{% endblock %}

{% block content %}
  {# Breadcrumb Section #}
  <section class="px-4 py-6 md:px-16">
    <div class="theme-container">
      {%
        with
        items=[
          {'href': url_for('home'), 'label': _("Home")},
          {'href': url_for('product_details', slug=product.slug), 'label': product.name},
          {'label': _("Reviews")}
        ]
      %}
        {% include 'components/ui/breadcrumb.jinja' %}
      {% endwith %}
    </div>
  </section>

  {# Reviews Section #}
  <section class="px-4 pb-12 md:px-16 md:pb-16">
    <div class="theme-container">
      {# Product Header #}
      <a
        href="{{ url_for('product_details', slug=product.slug) }}"
        class="mb-8 flex items-center gap-4 transition-opacity hover:opacity-80"
      >
        <div class="size-16 shrink-0 overflow-hidden rounded">
          {% if product.main_image %}
            <img
              src="{{ image_url(product.main_image.image.medium, w=64, h=64, q=85, f='auto') }}"
              alt="{{ product.name }}"
              class="size-full object-cover"
            />
          {% else %}
            <div class="bg-secondary size-full"></div>
          {% endif %}
        </div>
        <div>
          <h1 class="text-foreground text-h5 text-caps">{{ product.name }}</h1>
          {% if product.rating %}
            <div class="mt-1 flex items-center gap-2">
              {% with rating=product.rating.average %}
                {% include 'components/rating-stars.jinja' %}
              {% endwith %}
              <span class="text-muted text-body2">({{ product.rating.total_count }} {{ _("reviews") }})</span>
            </div>
          {% endif %}
        </div>
      </a>

      <div class="grid grid-cols-1 gap-8 lg:grid-cols-12">
        {# Left Column: Rating Breakdown #}
        <div class="lg:col-span-4">
          <div class="bg-secondary sticky top-32 rounded-lg p-6">
            <div class="mb-6 flex items-center justify-between">
              <h2 class="text-foreground text-h6">{{ _("Reviews") }}</h2>
              <a
                href="{{ url_for('add_product_review', slug=product.id) }}"
                class="btn btn-filled btn-sm"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M12 5v14M5 12h14" />
                </svg>
                {{ _("Add review") }}
              </a>
            </div>

            {% if product.rating %}
              {# Average Rating #}
              <div class="mb-6 flex items-center gap-4">
                <span class="text-foreground text-h2">{{ product.rating.average }}</span>
                <div>
                  {% with rating=product.rating.average %}
                    {% include 'components/rating-stars.jinja' %}
                  {% endwith %}
                  <p class="text-muted text-caption mt-1">{{ product.rating.total_count }} {{ _("reviews") }}</p>
                </div>
              </div>

              {# Rating Bars #}
              <div class="space-y-2">
                {# 5 Stars #}
                <div class="flex items-center gap-3">
                  <span class="text-muted text-caption w-4 shrink-0">5</span>
                  <svg
                    class="text-warning size-4 shrink-0"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                    />
                  </svg>
                  <div class="bg-border-light h-2 flex-1 overflow-hidden rounded-full">
                    {% set percent = (product.rating.ratings_5.count / product.rating.total_count * 100) if product.rating.total_count > 0 else 0 %}
                    <div
                      class="bg-warning h-full rounded-full"
                      style="width: {{ percent }}%"
                    ></div>
                  </div>
                  <span class="text-muted text-caption w-8 shrink-0 text-end"
                    >{{ product.rating.ratings_5.count }}</span
                  >
                </div>

                {# 4 Stars #}
                <div class="flex items-center gap-3">
                  <span class="text-muted text-caption w-4 shrink-0">4</span>
                  <svg
                    class="text-warning size-4 shrink-0"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                    />
                  </svg>
                  <div class="bg-border-light h-2 flex-1 overflow-hidden rounded-full">
                    {% set percent = (product.rating.ratings_4.count / product.rating.total_count * 100) if product.rating.total_count > 0 else 0 %}
                    <div
                      class="bg-warning h-full rounded-full"
                      style="width: {{ percent }}%"
                    ></div>
                  </div>
                  <span class="text-muted text-caption w-8 shrink-0 text-end"
                    >{{ product.rating.ratings_4.count }}</span
                  >
                </div>

                {# 3 Stars #}
                <div class="flex items-center gap-3">
                  <span class="text-muted text-caption w-4 shrink-0">3</span>
                  <svg
                    class="text-warning size-4 shrink-0"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                    />
                  </svg>
                  <div class="bg-border-light h-2 flex-1 overflow-hidden rounded-full">
                    {% set percent = (product.rating.ratings_3.count / product.rating.total_count * 100) if product.rating.total_count > 0 else 0 %}
                    <div
                      class="bg-warning h-full rounded-full"
                      style="width: {{ percent }}%"
                    ></div>
                  </div>
                  <span class="text-muted text-caption w-8 shrink-0 text-end"
                    >{{ product.rating.ratings_3.count }}</span
                  >
                </div>

                {# 2 Stars #}
                <div class="flex items-center gap-3">
                  <span class="text-muted text-caption w-4 shrink-0">2</span>
                  <svg
                    class="text-warning size-4 shrink-0"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                    />
                  </svg>
                  <div class="bg-border-light h-2 flex-1 overflow-hidden rounded-full">
                    {% set percent = (product.rating.ratings_2.count / product.rating.total_count * 100) if product.rating.total_count > 0 else 0 %}
                    <div
                      class="bg-warning h-full rounded-full"
                      style="width: {{ percent }}%"
                    ></div>
                  </div>
                  <span class="text-muted text-caption w-8 shrink-0 text-end"
                    >{{ product.rating.ratings_2.count }}</span
                  >
                </div>

                {# 1 Star #}
                <div class="flex items-center gap-3">
                  <span class="text-muted text-caption w-4 shrink-0">1</span>
                  <svg
                    class="text-warning size-4 shrink-0"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                    />
                  </svg>
                  <div class="bg-border-light h-2 flex-1 overflow-hidden rounded-full">
                    {% set percent = (product.rating.ratings_1.count / product.rating.total_count * 100) if product.rating.total_count > 0 else 0 %}
                    <div
                      class="bg-warning h-full rounded-full"
                      style="width: {{ percent }}%"
                    ></div>
                  </div>
                  <span class="text-muted text-caption w-8 shrink-0 text-end"
                    >{{ product.rating.ratings_1.count }}</span
                  >
                </div>
              </div>
            {% else %}
              <p class="text-muted text-body2">{{ _("No reviews yet") }}</p>
            {% endif %}
          </div>
        </div>

        {# Right Column: Reviews List #}
        <div class="lg:col-span-8">
          {% if product.reviews and product.reviews.results and product.reviews.results|length > 0 %}
            <div class="divide-border-light divide-y">
              {% for review in product.reviews.results %}
                <div class="py-6 first:pt-0">
                  {% with review=review, store=store %}
                    {% include 'components/products/review-card.jinja' %}
                  {% endwith %}
                </div>
              {% endfor %}
            </div>

            {# Pagination #}
            {% if product.reviews.pages_count > 1 %}
              <div class="mt-8">
                {% with totalPages=product.reviews.pages_count, currentPage=product.reviews.page %}
                  {% include 'components/products/pagination.jinja' %}
                {% endwith %}
              </div>
            {% endif %}
          {% else %}
            {# Empty State #}
            <div class="flex flex-col items-center justify-center py-16 text-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="64"
                height="64"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-muted-foreground mb-4"
              >
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
              </svg>
              <h2 class="text-foreground text-h6 mb-2">{{ _("No reviews yet") }}</h2>
              <p class="text-muted text-body2 mb-4">{{ _("Be the first to review this product") }}</p>
              <a
                href="{{ url_for('add_product_review', slug=product.id) }}"
                class="btn btn-filled"
              >
                {{ _("Add review") }}
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>
{% endblock %}
