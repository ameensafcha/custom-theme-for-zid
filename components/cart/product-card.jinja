{% macro timeFormat(value) %}
  {%- if value -%}
    {%- set parts = value.split(':') -%}
    {%- if parts | length >= 2 -%}
      {%- set hour = parts[0] | int -%}
      {%- set minute = parts[1] -%}
      {%- set period = 'AM' if hour < 12 else 'PM' -%}
      {%- set display_hour = hour if hour <= 12 else hour - 12 -%}
      {%- set display_hour = 12 if display_hour == 0 else display_hour -%}
      {{- display_hour }}:{{ minute }}
      {{ period -}}
    {%- else -%}
      {{- value -}}
    {%- endif -%}
  {%- endif -%}
{% endmacro %}

<div
  class="cart-product-item flex gap-2 lg:gap-6"
  data-cart-product-id="{{ product.id }}"
>
  <a
    href="{{ product.url }}"
    class="block size-20 shrink-0 overflow-hidden rounded"
  >
    {% if product.images and product.images | length > 0 %}
      <img
        src="{{ image_url(product.images[0].thumbs.fullSize, w=80, h=80, q=85, f='auto') }}"
        srcset="
          {{ image_url(product.images[0].thumbs.fullSize, w=80, h=80, q=85, f='auto') }} 1x,
          {{ image_url(product.images[0].thumbs.fullSize, w=160, h=160, q=85, f='auto') }} 2x
        "
        alt="{{ product.name }}"
        class="size-full object-cover"
        loading="lazy"
      />
    {% else %}
      <img
        src="{{ image_url(('images/placeholder-image.svg' | asset_url), w=400, q=100, f='auto') }}"
        alt="{{ product.name }}"
        class="bg-secondary size-full object-cover"
      />
    {% endif %}
  </a>

  {# Content Area - responsive layout switch #}
  <div class="flex min-w-0 flex-1 flex-col gap-4 lg:flex-row lg:gap-6">
    {# Column 1: Product Info (flex-1 on desktop) #}
    <div class="flex min-w-0 flex-1 flex-col gap-1">
      {# Row Header: Name + Price (mobile only - price positioned here) #}
      <div class="flex items-start justify-between gap-2 lg:block">
        {# Product Name & Variants #}
        <div class="min-w-0 flex-1 lg:flex-none">
          {# Product Name (H6 - 20px, max 2 lines) #}
          <a
            href="{{ product.url }}"
            class="text-foreground text-sm font-medium line-clamp-2 hover:underline"
          >
            {{ product.name }}
          </a>

          {# Variant Info / Custom Fields - Disclosure Pattern #}
          {% if product.custom_fields and product.custom_fields | length > 0 %}
            <button
              type="button"
              class="text-foreground text-xs mt-1 flex items-center gap-1 hover:underline"
              data-action="custom-fields-toggle"
              data-custom-fields-id="custom-fields-{{ product.id }}"
            >
              <span>{{ product.custom_fields | length }} {{ _("options selected") }}</span>
              <svg
                class="size-3 transition-transform"
                data-custom-fields-arrow="{{ product.id }}"
                viewBox="0 0 16 16"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M4 6l4 4 4-4"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>

            {# Custom Fields List (Collapsible) #}
            <div
              id="custom-fields-{{ product.id }}"
              class="bg-secondary/50 mt-1 hidden flex-col gap-2 rounded p-2 lg:mt-0 lg:p-3"
            >
              {% for custom_field in product.custom_fields %}
                <div class="text-sm flex items-start gap-2">
                  {%- if custom_field.type == 'TEXT' or custom_field.type == 'NUMBER' -%}
                    <span class="text-muted-foreground shrink-0">{{ custom_field.name }}:</span>
                    <span class="text-foreground">{{ custom_field.value | safe }}</span>
                  {%- elif custom_field.type == 'DATE' -%}
                    <span class="text-muted-foreground shrink-0">{{ custom_field.name }}:</span>
                    <span class="text-foreground">{{ custom_field.value }}</span>
                  {%- elif custom_field.type == 'TIME' -%}
                    <span class="text-muted-foreground shrink-0">{{ custom_field.name }}:</span>
                    <span class="text-foreground">{{ timeFormat(custom_field.value) }}</span>
                  {%- elif custom_field.type == 'CHECKBOX' or custom_field.type == 'DROPDOWN' -%}
                    <span class="text-muted-foreground shrink-0">{{ custom_field.label }}:</span>
                    <span class="text-foreground">{{ custom_field.name }}</span>
                  {%- elif custom_field.type == 'IMAGE' -%}
                    <span class="text-muted-foreground shrink-0">{{ custom_field.name }}:</span>
                    <a
                      href="{{ custom_field.formatted_value }}"
                      target="_blank"
                      class="block size-10 shrink-0 overflow-hidden rounded border"
                    >
                      <img
                        src="{{ image_url(custom_field.formatted_value, w=80, q=85, f='auto') }}"
                        alt="{{ custom_field.name }}"
                        class="size-full object-cover"
                        loading="lazy"
                      />
                    </a>
                  {%- elif custom_field.type == 'FILE' -%}
                    <span class="text-muted-foreground shrink-0">{{ custom_field.name }}:</span>
                    <a
                      href="{{ custom_field.formatted_value }}"
                      target="_blank"
                      class="text-foreground underline hover:no-underline"
                    >
                      {{ _('Download') }}
                    </a>
                  {%- else -%}
                    <span class="text-foreground">{{ custom_field.value | safe }}</span>
                  {%- endif -%}
                  {%- if custom_field.additions_price -%}
                    <span class="text-accent shrink-0">(+{{ custom_field.additions_price_string }})</span>
                  {%- endif -%}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        {# Price (Mobile: top-right, Desktop: hidden here - shown in Column 3) #}
        <div class="flex shrink-0 flex-col items-end lg:hidden">
          <p class="text-foreground text-sm font-medium">{{ product.total_string }}</p>
          {% if product.total_before_string %}
            <p class="text-destructive text-sm line-through">{{ product.total_before_string }}</p>
          {% endif %}
          {% if product.quantity > 1 and product.product_class != 'crowdfunding_project' %}
            <p class="text-muted text-xs">{{ _("per item") }}: {{ product.price_string }}</p>
          {% endif %}
        </div>
      </div>

      {# Bundle Offer Tag (only show if product is discounted with bundle offer) #}
      {% if product.is_discounted and product.meta and product.meta.bundle_offer %}
        <div class="text-muted text-sm flex items-center gap-1">
          <svg
            class="size-4"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M13.333 7.333V4.667A.667.667 0 0012.667 4h-10A.667.667 0 002 4.667v2.666a1.333 1.333 0 010 2.667v2.667c0 .368.299.666.667.666h10a.667.667 0 00.666-.666V9.333a1.333 1.333 0 010-2.667zM6 10.667a.667.667 0 110-1.334.667.667 0 010 1.334zm0-2a.667.667 0 110-1.334.667.667 0 010 1.334zm0-2a.667.667 0 110-1.334.667.667 0 010 1.334z"
              fill="currentColor"
            ></path>
          </svg>
          <span>{{ product.meta.bundle_offer.name }}</span>
        </div>
      {% endif %}

      {# Bundle Sub-Items Toggle (shown for any product with sub_items - dynamic bundles, static bundles, etc.) #}
      {% if product.sub_items and product.sub_items | length > 0 %}
        <button
          type="button"
          class="text-foreground text-xs flex items-center gap-1 hover:underline"
          data-action="bundle-toggle"
          data-bundle-id="bundle-{{ product.id }}"
        >
          <span>{{ product.sub_items | length }} {{ _("items included") }}</span>
          <svg
            class="size-3 transition-transform"
            data-bundle-arrow="{{ product.id }}"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M4 6l4 4 4-4"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>

        {# Bundle Sub-Items List (Collapsible) #}
        <div
          id="bundle-{{ product.id }}"
          class="bg-secondary/50 mt-1 hidden flex-col gap-2 rounded p-2 lg:mt-0 lg:p-3"
        >
          {% for sub_item in product.sub_items %}
            <div class="flex items-center gap-2">
              {# Sub-item Image #}
              <div class="size-10 shrink-0 overflow-hidden rounded">
                {% if sub_item.images and sub_item.images | length > 0 %}
                  <img
                    src="{{ image_url(sub_item.images[0].thumbs.fullSize, w=40, h=40, q=85, f='auto') }}"
                    alt="{{ sub_item.name }}"
                    class="size-full object-cover"
                    loading="lazy"
                  />
                {% else %}
                  <img
                    src="{{ image_url(('images/placeholder-image.svg' | asset_url), w=128, q=100, f='auto') }}"
                    alt="{{ sub_item.name }}"
                    class="bg-secondary size-full object-cover"
                  />
                {% endif %}
              </div>

              {# Sub-item Details #}
              <div class="min-w-0 flex-1">
                <p class="text-foreground text-xs truncate">{{ sub_item.product_name or sub_item.name }}</p>
                <div class="text-muted text-xs flex items-center gap-2">
                  <span class="lg:hidden">{{ _("Qty") }}: {{ sub_item.quantity }}</span>
                  <span class="hidden lg:inline">{{ _("Quantity") }}: {{ sub_item.quantity }}</span>
                  {% if sub_item.price_string %}
                    <span>{{ sub_item.price_string }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    {# Column 2: Quantity (w-48 on desktop, row on mobile) #}
    <div class="flex items-center justify-between gap-4 lg:w-48 lg:flex-col lg:items-start lg:justify-start lg:gap-2">
      {% if product.product_class != 'crowdfunding_project' %}
        {# Quantity Input #}
        {%
          with
          id='cart-qty-' ~ product.id,
          quantity=product.quantity,
          cart_product_id=product.id,
          product_id=product.product_id,
          max=product.original_product_quantity,
          full_width=true
        %}
          {% include 'components/ui/quantity-input.jinja' %}
        {% endwith %}

        {# Stock Warning (optional) - shown below quantity on desktop, separate on mobile #}
        {% if product.original_product_quantity and product.original_product_quantity <= 5 %}
          <p class="text-muted text-xs hidden lg:block">
            {{ _("Only %(count)s left!") | format(count=product.original_product_quantity) }}
          </p>
        {% endif %}
      {% else %}
        {# Crowdfunding/Donation Input #}
        <div
          class="flex w-full items-center gap-2"
          data-donation-form-product-id="{{ product.id }}"
          data-donation-cart-form-product-id="{{ product.id }}"
          data-donation-message-lang="{{ session.lang.code }}"
        >
          <div class="relative flex-1">
            <input
              type="text"
              class="form-input w-full pe-12"
              data-cart-product-id="{{ product.id }}"
              data-product-id="{{ product.product_id }}"
              data-template="template_for_cart_products_list"
              data-donation-remaining-amount="{{ product.original_product_quantity }}"
              value="{{ product.total | round(2, 'common') }}"
              data-donation-input
            />
            <span class="text-muted-foreground absolute end-3 top-1/2 -translate-y-1/2">
              {{ session.currency.symbol }}
            </span>
          </div>
          <span
            class="text-destructive text-xs hidden"
            data-donation-remaining-amount-exceed-message
          ></span>
        </div>
      {% endif %}

      {# Actions: Wishlist + Delete (Mobile only - shown here) #}
      <div class="flex items-center gap-2 lg:hidden">
        {# Wishlist Heart Icon #}
        <button
          type="button"
          class="text-foreground flex size-8 items-center justify-center"
          data-wishlist-btn
          data-product-id="{{ product.product_id }}"
          aria-label="{{ _('Add to wishlist') }}"
        >
          <svg
            class="size-4"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M8 13.933l-1.033-.94C3.6 9.867 1.333 7.827 1.333 5.333 1.333 3.293 2.96 1.667 5 1.667c1.153 0 2.26.537 3 1.38a4.012 4.012 0 013-1.38c2.04 0 3.667 1.626 3.667 3.666 0 2.494-2.267 4.534-5.634 7.667L8 13.933z"
              stroke="currentColor"
              stroke-width="1.2"
            />
          </svg>
        </button>

        {# Delete Trash Icon #}
        <button
          type="button"
          class="text-foreground flex size-8 items-center justify-center"
          data-action="product-remove"
          data-cart-product-id="{{ product.id }}"
          data-product-id="{{ product.product_id }}"
          data-template="template_for_cart_products_list"
          aria-label="{{ _('Remove from cart') }}"
        >
          <svg
            class="cart-product-delete-icon size-4"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M2 4h12M5.333 4V2.667a1.333 1.333 0 011.334-1.334h2.666a1.333 1.333 0 011.334 1.334V4m2 0v9.333a1.333 1.333 0 01-1.334 1.334H4.667a1.333 1.333 0 01-1.334-1.334V4h9.334z"
              stroke="currentColor"
              stroke-width="1.2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <svg
            class="cart-product-delete-spinner hidden size-4 animate-spin"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
          </svg>
        </button>
      </div>
    </div>

    {# Column 3: Price & Actions (w-48 on desktop, hidden on mobile - shown inline above) #}
    <div class="hidden w-48 flex-col items-end gap-2.5 lg:flex">
      {# Price Display #}
      <div class="flex flex-col items-end gap-1">
        <p class="text-foreground text-sm font-medium">{{ product.total_string }}</p>
        {% if product.total_before_string %}
          <p class="text-destructive text-sm line-through">{{ product.total_before_string }}</p>
        {% endif %}
        {% if product.quantity > 1 and product.product_class != 'crowdfunding_project' %}
          <p class="text-muted text-xs">{{ _("per item") }}: {{ product.price_string }}</p>
        {% endif %}
      </div>

      {# Action Icons #}
      <div class="flex items-center gap-2">
        {# Wishlist Heart Icon #}
        <button
          type="button"
          class="text-foreground hover:bg-secondary flex size-8 items-center justify-center rounded transition-colors"
          data-wishlist-btn
          data-product-id="{{ product.product_id }}"
          aria-label="{{ _('Add to wishlist') }}"
        >
          <svg
            class="size-4"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M8 13.933l-1.033-.94C3.6 9.867 1.333 7.827 1.333 5.333 1.333 3.293 2.96 1.667 5 1.667c1.153 0 2.26.537 3 1.38a4.012 4.012 0 013-1.38c2.04 0 3.667 1.626 3.667 3.666 0 2.494-2.267 4.534-5.634 7.667L8 13.933z"
              stroke="currentColor"
              stroke-width="1.2"
            />
          </svg>
        </button>

        {# Delete Trash Icon #}
        <button
          type="button"
          class="text-foreground hover:bg-secondary flex size-8 items-center justify-center rounded transition-colors"
          data-action="product-remove"
          data-cart-product-id="{{ product.id }}"
          data-product-id="{{ product.product_id }}"
          data-template="template_for_cart_products_list"
          aria-label="{{ _('Remove from cart') }}"
        >
          <svg
            class="cart-product-delete-icon size-4"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M2 4h12M5.333 4V2.667a1.333 1.333 0 011.334-1.334h2.666a1.333 1.333 0 011.334 1.334V4m2 0v9.333a1.333 1.333 0 01-1.334 1.334H4.667a1.333 1.333 0 01-1.334-1.334V4h9.334z"
              stroke="currentColor"
              stroke-width="1.2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <svg
            class="cart-product-delete-spinner hidden size-4 animate-spin"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

{# Mobile Stock Warning (shown below the card) #}
{% if product.product_class != 'crowdfunding_project' and product.original_product_quantity and product.original_product_quantity <= 5 %}
  <p class="text-muted text-xs -mt-2 ps-[88px] pb-2 lg:hidden">
    {{ _("Only %(count)s left!") | format(count=product.original_product_quantity) }}
  </p>
{% endif %}

{# Tax Free Notice #}
{% if product.is_taxable == false %}
  <p class="text-success text-xs -mt-2 ps-[88px] pb-2 lg:ps-0">{{ _("Tax free") }}</p>
{% endif %}

{# Error Message #}
{% if product.error_message %}
  <p class="text-destructive text-xs -mt-2 ps-[88px] pb-2 lg:ps-0">{{ _(product.error_message) }}</p>
{% endif %}
